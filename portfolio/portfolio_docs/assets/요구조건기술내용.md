# **스마트폰/태블릿 기반 AI 품질 상황 판단 및 리포팅 시스템 통합 로드맵**

## **1. 개요 (Overview)**
본 문서는 포항 공장의 5대 핵심 공정(압연, 프레스, 표면처리, 용접, 주조)을 대상으로, 자체 보유 플랫폼 기술인 `Image_Labeling_Platform`과 `AI_agent_test`를 결합하여 **지능형 공정 상황 판단 및 리포팅 시스템** 구축을 위한 마스터 플랜입니다. 

핵심 전략은 **'보는 놈(Vision/Halcon)'**과 **'아는 놈(AMS/Time-series)'**을 철저히 분리하되, 이 둘을 외부 솔루션이 아닌 **내부 플랫폼의 모듈(Module)**로서 긴밀하게 통합하는 것입니다.

---

## **2. 시스템 통합 아키텍처 (Codebase Level Architecture)**

**DPS(데이터수집시스템)** 레이어는 외부 장비가 아닌, 우리 플랫폼 내의 `Base.Maui` 및 `HalconApp` 프로젝트 코드로 구동됩니다.

```mermaid
graph TD
    %% Define Styles
    classDef platform fill:#f9f,stroke:#333,stroke-width:2px;
    classDef logic fill:#dfd,stroke:#333,stroke-width:2px;
    classDef core fill:#fdd,stroke:#333,stroke-width:2px;

    subgraph "DPS Layer (Image_Labeling_Platform)"
        HalconApp[HalconApp (C#)\nMainForm.cs / SendToWeb]:::platform
        BaseMaui[Base.Maui (App)\nMobile Interface]:::platform
        DPS_POP[DPS-POP\nProduction Context]:::platform
    end

    subgraph "Intelligence Layer (AI_agent_test)"
        MLS[01_MLS (Python)\nmain_mls.py / feature_progress.py]:::logic
        DL_Engine[Deep Learning Engine\nAi_preprocessing.py]:::logic
        GenAI[GenAI Reporter\n(Gemini 3.0)]:::logic
        TUS[TUS Server\nTusClientWrapper]:::core
    end

    subgraph "Knowledge Layer"
        FMEA[FMEA Automation]:::core
        Eval[Evaluation Framework]:::core
    end

    %% Data Flow
    HalconApp --"1. Pipeline JSON (Nodes/Edges)"--> HalconApp
    HalconApp --"2. Extract Feature (SendTestPipelineJson)"--> MLS
    DPS_POP --"3. Context Data"--> MLS
    
    MLS --"4. featrue_progress_main"--> DL_Engine
    DL_Engine --"5. Time-Series Analysis"--> GenAI
    
    GenAI --"6. Report"--> Eval
    FMEA -.-> MLS
```

---

## **3. 보유 기술 상세 명세 (Code-Level Specification)**

### **3.1 DPS Vision System (Built-in Halcon Platform)**
*   **Source Code:** `Image_Labeling_Platform/HalconApp`
*   **Core Component:** `MainForm.cs`, `HalconPipelineEditor`
*   **기능 정의:** 별도의 외부 비전 소프트웨어를 쓰지 않고, 자체 C# 플랫폼 내에 **MVTec Halcon** 라이브러리를 직접 임베딩하여 구동합니다.
*   **구현 상세:**
    *   **Pipeline JSON:** `MainForm.cs`의 `SendTestPipelineJson()` 메서드를 통해 `Threshold`, `FileWatch`, `LocalSaveImage`와 같은 노드 기반 파이프라인을 동적으로 구성합니다.
    *   **Node-Link Structure:**
        ```json
        "nodes": [ {"id": "1", "kind": "FileWatch"}, {"id": "2", "kind": "Threshold", "parameters": {"min": 100, "max": 255}} ],
        "connections": [ {"fromNodeId": "1", "toNodeId": "2"} ]
        ```
    *   **Deep Learning (Embedding):** 단순 규칙 기반이 아닌, Halcon의 DL 모델(`DeepLearningObjDet` 등)을 노드로 로드하여 태블릿/엣지에서 추론(Inference)을 직접 수행합니다.

### **3.2 AMS (Time-Series Intelligence Core)**
*   **Source Code:** `AI_agent_test/AMS/AI_docker_en/01_MLS`
*   **Core Component:** `main_mls.py`, `feature_progress.py`, `data_amp_test.py`
*   **기능 정의:** Vision에서 올라온 Raw Feature를 시계열로 재가공하여 의미를 찾는 두뇌입니다.
*   **구현 상세:**
    *   **Feature Progression:** `feature_progress.py`의 `featrue_progress_main()` 함수가 Vision 데이터(`Halcon` 결과값)의 노이즈를 제거하고 정규화합니다.
    *   **Dimensionality Reduction:** `dimension_label_select.py`를 통해 수백 개의 Vision Feature 중 '불량'과 가장 연관성 높은 핵심 인자(Principal Component)만 추출합니다.
    *   **Auto Labeling:** `make_label_auto.py`는 `main_make_label_auto()`를 호출하여, 비지도 학습(Unsupervised) 방식으로 이상 징후 구간에 자동으로 라벨(0/1)을 부여합니다.
    *   **Virtual Sensor (VRS):** `Make_virtual_sensor.py`는 실제 센서가 없는 위치의 값을 주변 데이터(Vision+PLC) 상관관계를 통해 가상으로 생성해냅니다.

---

## **4. 통합 데이터 파이프라인 (Unified Pipeline Flow)**

### **Step 1: Edge Computing (in `HalconApp`)**
1.  **Capture:** `FileWatch` 노드가 카메라 스트림 획득.
2.  **Process:** `Threshold` 및 `DeepLearning` 노드가 이미지에서 `Spark_Area`(불꽃 면적), `Crack_Len`(크랙 길이) 수치 추출.
3.  **Transmit:** `SendToWeb("pipeline.set", json)`을 호출하여 추출된 Feature 데이터(이미지 아님)를 서버로 전송.

### **Step 2: Server Intelligence (in `01_MLS`)**
1.  **Ingest:** `tus_client.py`의 `TusClientWrapper`가 대용량 시계열 로그 데이터를 수신.
2.  **Sync:** `main_mls.py` 메인 루프에서 POP 데이터(Context)와 Vision Feature를 `job_id` 기준으로 동기화.
3.  **Analyze:** `data_amp_test.py`가 시계열 구간 통계(Window Statistics)를 산출하여 "급격한 변화 패턴" 감지.
4.  **Infer:** AMS가 FMEA DB를 조회하여, 현재의 시계열 패턴이 '용접봉 흡습' 불량 모드와 85% 일치함을 확인.

### **Step 3: Actionable Output**
1.  **Generate:** `GenAI Connector`가 "2호기 용접 불꽃이 30% 커졌으며(Vision), 이는 FMEA상 용접봉 습기 문제(Prob: 85%)로 추정됩니다." 리포트 생성.
2.  **Optimize:** `Evaluation Framework`가 이 리포트의 정확도를 채점하고, 피드백을 다시 `AMS`의 가중치로 역전파(Back-propagation).

---

## **5. 결론 및 기대효과**

우리는 외부 솔루션에 의존하지 않습니다. 
*   **HalconApp** 코드를 수정하여 새로운 검사 알고리즘을 즉시 배포할 수 있습니다.
*   **main_mls.py** 로직을 고쳐 시계열 분석 규칙을 우리 공장에 맞게 최적화할 수 있습니다.

이 시스템은 우리가 가진 **코드 자산(Code Asset)** 그 자체이며, 모든 라인이 우리의 통제 하에 있는 **완전한 화이트박스(White-box) 솔루션**입니다.